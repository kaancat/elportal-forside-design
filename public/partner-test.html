<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DinElportal Partner Integration Guide</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #1f2937;
            background: #f3f4f6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            border-left: 4px solid #10b981;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 16px;
        }
        
        .goal-box {
            background: #ecfdf5;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .goal-box h2 {
            color: #047857;
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        .goal-box p {
            color: #047857;
            font-size: 16px;
            line-height: 1.8;
        }
        
        .step {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .step.completed {
            border-left: 4px solid #10b981;
            background: #f0fdf4;
        }
        
        .step.current {
            border-left: 4px solid #3b82f6;
            background: #eff6ff;
        }
        
        .step-header {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .step-number {
            background: #6366f1;
            color: white;
            min-width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .step.completed .step-number {
            background: #10b981;
        }
        
        .step-content h2 {
            font-size: 22px;
            color: #1f2937;
            margin-bottom: 10px;
        }
        
        .step-description {
            color: #6b7280;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .action-box {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .action-box h3 {
            color: #374151;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .what-to-do {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .what-to-do strong {
            color: #92400e;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .what-to-do p {
            color: #92400e;
            font-size: 15px;
            margin: 0;
            line-height: 1.6;
        }
        
        .code-example {
            background: #1f2937;
            color: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 20px 0;
            position: relative;
        }
        
        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4b5563;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .copy-button:hover {
            background: #6b7280;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .status-item {
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .status-item.checking {
            border-left-color: #3b82f6;
            background: #eff6ff;
            animation: pulse 2s infinite;
        }
        
        .status-item.success {
            border-left-color: #10b981;
            background: #d1fae5;
        }
        
        .status-item.error {
            border-left-color: #ef4444;
            background: #fee2e2;
        }
        
        .status-item.warning {
            border-left-color: #f59e0b;
            background: #fef3c7;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .status-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .status-value {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            word-break: break-all;
        }
        
        .status-icon {
            font-size: 20px;
            margin-right: 5px;
        }
        
        .input-group {
            margin: 20px 0;
        }
        
        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #6366f1;
        }
        
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .button:hover {
            background: #2563eb;
        }
        
        .button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .button.success {
            background: #10b981;
        }
        
        .button.success:hover {
            background: #059669;
        }
        
        .button.secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .button.secondary:hover {
            background: #f9fafb;
        }
        
        .code-block {
            background: #1f2937;
            color: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 20px 0;
            position: relative;
        }
        
        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4b5563;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .copy-button:hover {
            background: #6b7280;
        }
        
        .test-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .result-box {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .result-box.show {
            display: block;
        }
        
        .result-box pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .success-message {
            color: #059669;
            font-weight: 600;
            margin-top: 10px;
            display: none;
        }
        
        .success-message.show {
            display: block;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            position: relative;
            transition: color 0.3s;
        }
        
        .tab.active {
            color: #6366f1;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #6366f1;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .checklist {
            margin: 20px 0;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f9fafb;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .checklist-item.completed {
            background: #d1fae5;
        }
        
        .checklist-icon {
            margin-right: 10px;
            font-size: 20px;
        }
        
        .checklist-text {
            flex: 1;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .event-item {
            padding: 10px;
            background: #f9fafb;
            border-left: 3px solid #3b82f6;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .event-time {
            color: #6b7280;
            font-size: 11px;
        }
        
        .event-type {
            font-weight: 600;
            color: #1f2937;
        }
        
        .info-box {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>DinElportal Partner Integration Guide</h1>
            <p>Follow this step-by-step guide to integrate DinElportal tracking on your website</p>
        </div>

        <!-- Goal Box -->
        <div class="goal-box">
            <h2>üéØ What we're doing today:</h2>
            <p>
                1. Test that our tracking script works on this page<br>
                2. Get your unique integration code<br>
                3. Understand how to add it to your website<br>
                4. Verify that conversions will be tracked correctly
            </p>
        </div>

        <!-- Step 1: Test the Tracking Here -->
        <div class="step current" id="step1">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h2>First, let's test the tracking on this page</h2>
                    <p class="step-description">
                        We'll load the tracking script on this test page to make sure everything works correctly.
                        This is just for testing - you'll add the real code to your website in Step 2.
                    </p>
                </div>
            </div>
            
            <div class="action-box">
                <h3>Enter your Partner ID below:</h3>
                <div class="input-group">
                    <input type="text" id="partnerId" placeholder="e.g., vindstod, andelenergi, ok" value="">
                    <p style="font-size: 14px; color: #6b7280; margin-top: 8px;">
                        This is the unique ID we gave you when you became a partner
                    </p>
                </div>
                <button class="button" onclick="testTracking()">Test Tracking Script</button>
            </div>
            
            <div id="testResult" class="result-box" style="display:none;">
                <pre id="testOutput"></pre>
            </div>
        </div>

        <!-- Step 2: Add to Your Website -->
        <div class="step" id="step2" style="display:none;">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h2>Add this code to YOUR website</h2>
                    <p class="step-description">
                        Great! The tracking works. Now you need to add this code to every page of your website.
                    </p>
                </div>
            </div>
            
            <div class="what-to-do">
                <strong>What to do:</strong>
                <p>Copy the code below and paste it into the &lt;head&gt; section of your website's HTML, on EVERY page.</p>
            </div>
            
            <div class="code-example">
                <button class="copy-button" onclick="copyCode()">Copy Code</button>
                <code id="integrationCode"></code>
            </div>
            
            <div class="action-box">
                <h3>Where exactly should I paste this?</h3>
                <p style="margin-bottom: 15px;">The code goes between the &lt;head&gt; and &lt;/head&gt; tags in your HTML:</p>
                <pre style="background: #f9fafb; padding: 15px; border-radius: 6px; font-size: 13px;">
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Your Website&lt;/title&gt;
    <span style="background: #fef3c7; padding: 2px 4px;">
    &lt;!-- Paste the DinElportal code here --&gt;
    &lt;script src="..." async&gt;&lt;/script&gt;</span>
  &lt;/head&gt;
  &lt;body&gt;
    ...
  &lt;/body&gt;
&lt;/html&gt;</pre>
                
                <div style="margin-top: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="addedToWebsite" onchange="checkAddedToWebsite()">
                        <span>I have added this code to my website</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Step 3: Test on Your Website -->
        <div class="step" id="step3" style="display:none;">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h2>Verify Tracking is Working</h2>
                    <p class="step-description">
                        Let's confirm that your tracking is actively collecting data and working correctly.
                    </p>
                </div>
            </div>
            
            <!-- Live Tracking Status Section -->
            <div class="action-box" style="background: #f0f9ff; border: 2px solid #3b82f6; margin-bottom: 20px;">
                <h3>üîç Live Tracking Status</h3>
                <p style="color: #6b7280; margin-bottom: 15px;">
                    Check if your tracking is receiving data in real-time:
                </p>
                
                <button class="button" onclick="checkTrackingStatus()" id="checkStatusBtn">
                    Check Live Status
                </button>
                
                <div id="trackingStatus" style="display:none; margin-top: 20px;">
                    <div class="status-grid">
                        <div class="status-item" id="statusConnection">
                            <div class="status-label">Connection Status</div>
                            <div class="status-value">Checking...</div>
                        </div>
                        
                        <div class="status-item" id="statusEvents">
                            <div class="status-label">Events Today</div>
                            <div class="status-value">--</div>
                        </div>
                        
                        <div class="status-item" id="statusLastEvent">
                            <div class="status-label">Last Event</div>
                            <div class="status-value">--</div>
                        </div>
                    </div>
                    
                    <!-- Recent Events Display -->
                    <div id="recentEvents" style="margin-top: 20px; display:none;">
                        <h4 style="margin-bottom: 10px;">üìä Recent Tracking Events:</h4>
                        <div id="eventsList" style="max-height: 200px; overflow-y: auto; background: white; border-radius: 8px; padding: 10px;">
                            <!-- Events will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- What We Track Section -->
            <div class="info-box" style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 20px; margin-bottom: 20px;">
                <h3>üìà What Data We Track</h3>
                <p style="margin-bottom: 10px;">When the tracking script is active, we collect:</p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><strong>Click IDs:</strong> Anonymous identifiers (e.g., dep_abc123xyz)</li>
                    <li><strong>Page Views:</strong> Which pages users visit on your site</li>
                    <li><strong>Conversions:</strong> When users complete signup/purchase</li>
                    <li><strong>Attribution:</strong> Linking conversions back to DinElportal referrals</li>
                </ul>
                <p style="color: #6b7280; font-size: 14px; margin-top: 10px;">
                    <strong>Privacy:</strong> No personal data (names, emails, etc.) is collected. 
                    All tracking is GDPR compliant with 90-day data retention.
                </p>
            </div>
            
            <!-- How to Test Section -->
            <div class="what-to-do">
                <strong>How to test on YOUR website:</strong>
                <p>
                    1. Add the tracking script to your website (from Step 2)<br>
                    2. Open your website with this test URL:<br>
                    <code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px;">
                        https://your-website.dk/?click_id=dep_test_123
                    </code><br>
                    3. Navigate through your site and complete a test signup<br>
                    4. Click "Check Live Status" above to see your events
                </p>
            </div>
            
            <div class="action-box">
                <h3>Test the tracking flow:</h3>
                
                <button class="button" onclick="simulateTracking()">Simulate Tracking Events</button>
                <button class="button secondary" onclick="refreshStatus()" style="background: #6b7280;">
                    Refresh Status
                </button>
                
                <div id="simulateResult" style="display:none; margin-top: 20px;">
                    <p style="color: #10b981; font-weight: 600;">‚úÖ Simulation successful!</p>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        <p style="font-weight: 600; margin-bottom: 10px;">Simulated events sent:</p>
                        <ul style="margin: 5px 0; padding-left: 20px; color: #6b7280;">
                            <li>Click captured: dep_test_sim_123</li>
                            <li>Page view: /products</li>
                            <li>Page view: /signup</li>
                            <li>Conversion: signup completed</li>
                        </ul>
                        <p style="margin-top: 10px; color: #3b82f6;">
                            Click "Check Live Status" to see these events!
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: You're Done! -->
        <div class="step" id="step4" style="display:none;">
            <div class="step-header">
                <div class="step-number">‚úì</div>
                <div class="step-content">
                    <h2>Perfect! You're all set</h2>
                    <p class="step-description">
                        Your website is now integrated with DinElportal tracking.
                    </p>
                </div>
            </div>
            
            <div class="action-box" style="background: #ecfdf5; border: 2px solid #10b981;">
                <h3 style="color: #047857;">What happens next:</h3>
                <div style="margin-top: 15px; line-height: 2;">
                    <p>‚úÖ Users click your link on DinElportal</p>
                    <p>‚úÖ They arrive at your site with a tracking ID</p>
                    <p>‚úÖ Our script automatically captures this ID</p>
                    <p>‚úÖ When they sign up or purchase, we track the conversion</p>
                    <p>‚úÖ You get paid commission at the end of the month</p>
                </div>
            </div>
            
            <div class="action-box" style="margin-top: 20px;">
                <h3>Automatic conversion tracking on these pages:</h3>
                <p style="margin-top: 10px; color: #6b7280;">
                    Our script automatically detects conversions when users land on pages with these URLs:
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <div>
                        <strong style="font-size: 14px;">Danish pages:</strong>
                        <p style="font-size: 14px; color: #6b7280;">/tak, /bekraeftelse, /kvittering, /velkommen, /succes</p>
                    </div>
                    <div>
                        <strong style="font-size: 14px;">English pages:</strong>
                        <p style="font-size: 14px; color: #6b7280;">/thank-you, /thanks, /success, /confirmation, /complete</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div style="background: white; border-radius: 12px; padding: 30px; margin-top: 30px; border-top: 4px solid #6b7280;">
            <h2 style="margin-bottom: 20px;">Need help?</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 10px;">üìß Contact Support</h3>
                    <p style="color: #6b7280; font-size: 14px;">
                        Email: tech@dinelportal.dk<br>
                        Response time: Within 24 hours
                    </p>
                </div>
                <div>
                    <h3 style="font-size: 16px; margin-bottom: 10px;">üìö Documentation</h3>
                    <p style="color: #6b7280; font-size: 14px;">
                        Full guide: PARTNER-INTEGRATION-MASTER-GUIDE.md<br>
                        Includes troubleshooting and examples
                    </p>
                </div>
            </div>
            
            <button class="button secondary" style="margin-top: 20px;" onclick="startOver()">Start Over</button>
        </div>
    </div>
    
    <script>
        // Global variables
        let partnerId = '';
        let currentStep = 1;

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Check if partner_id is in URL for quick testing
            const urlParams = new URLSearchParams(window.location.search);
            const urlPartnerId = urlParams.get('partner_id');
            if (urlPartnerId) {
                document.getElementById('partnerId').value = urlPartnerId;
            }
        });

        // Test tracking script on this page
        function testTracking() {
            partnerId = document.getElementById('partnerId').value.trim();
            
            if (!partnerId) {
                alert('Please enter your Partner ID');
                return;
            }
            
            // Show loading state
            const resultBox = document.getElementById('testResult');
            const output = document.getElementById('testOutput');
            resultBox.style.display = 'block';
            output.textContent = 'Testing tracking script...';
            
            // Remove any existing script
            const existingScript = document.querySelector('script[data-dinelportal]');
            if (existingScript) {
                existingScript.remove();
            }
            
            // Add new script
            const script = document.createElement('script');
            script.src = `https://www.dinelportal.dk/api/tracking/universal.js?partner_id=${partnerId}&debug=true`;
            script.async = true;
            script.setAttribute('data-dinelportal', 'true');
            
            script.onload = function() {
                // Enable debug mode
                if (window.DinElportal && window.DinElportal.debug) {
                    window.DinElportal.debug(true);
                    console.log('‚úÖ DinElportal debug mode enabled - check browser console for detailed logs');
                }
                
                // Success! Show next steps
                output.innerHTML = `
<span style="color: #10b981; font-weight: 600;">‚úÖ Success! The tracking script works perfectly.</span>

What we tested:
‚Ä¢ Script loads correctly
‚Ä¢ DinElportal API is available
‚Ä¢ Ready to track conversions
‚Ä¢ Debug mode enabled (check browser console)

<span style="color: #6b7280;">Now let's get this code on YOUR website...</span>`;
                
                // Update step 1 to completed
                document.getElementById('step1').classList.remove('current');
                document.getElementById('step1').classList.add('completed');
                
                // Show step 2
                document.getElementById('step2').style.display = 'block';
                document.getElementById('step2').classList.add('current');
                
                // Update integration code
                document.getElementById('integrationCode').textContent = 
                    '<' + 'script src="https://www.dinelportal.dk/api/tracking/universal.js?partner_id=' + partnerId + '" async><' + '/script>';
                
                // Scroll to step 2
                setTimeout(() => {
                    document.getElementById('step2').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 500);
            };
            
            script.onerror = function() {
                output.innerHTML = `<span style="color: #ef4444;">‚ùå Failed to load script. Please check your Partner ID and try again.</span>`;
            };
            
            document.head.appendChild(script);
        }

        // Copy integration code
        function copyCode() {
            const code = document.getElementById('integrationCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const button = document.querySelector('.copy-button');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.style.background = '#10b981';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            });
        }
        
        // Check if added to website
        function checkAddedToWebsite() {
            const checkbox = document.getElementById('addedToWebsite');
            if (checkbox.checked) {
                // Update step 2 to completed
                document.getElementById('step2').classList.remove('current');
                document.getElementById('step2').classList.add('completed');
                
                // Show step 3
                document.getElementById('step3').style.display = 'block';
                document.getElementById('step3').classList.add('current');
                
                // Update test URL example
                document.getElementById('testUrl').textContent = 
                    `https://your-website.dk/?click_id=dep_test_123`;
                
                // Scroll to step 3
                setTimeout(() => {
                    document.getElementById('step3').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 500);
            }
        }
        
        // Check live tracking status
        async function checkTrackingStatus() {
            const partnerId = document.getElementById('partnerId').value || 'test-partner';
            const statusDiv = document.getElementById('trackingStatus');
            const statusConnection = document.getElementById('statusConnection');
            const statusEvents = document.getElementById('statusEvents');
            const statusLastEvent = document.getElementById('statusLastEvent');
            const checkBtn = document.getElementById('checkStatusBtn');
            
            // Show status div and update UI
            statusDiv.style.display = 'block';
            checkBtn.disabled = true;
            checkBtn.textContent = 'Checking...';
            
            // Update status items to checking state
            statusConnection.classList.add('checking');
            statusEvents.classList.add('checking');
            statusLastEvent.classList.add('checking');
            
            try {
                // Call the verification API
                const response = await fetch(`/api/tracking/verify?partner_id=${partnerId}`);
                const data = await response.json();
                
                // Update connection status
                statusConnection.classList.remove('checking');
                if (data.success && data.is_active) {
                    statusConnection.classList.add('success');
                    statusConnection.querySelector('.status-value').innerHTML = 
                        '<span class="status-icon">‚úÖ</span> Active';
                } else {
                    statusConnection.classList.add('warning');
                    statusConnection.querySelector('.status-value').innerHTML = 
                        '<span class="status-icon">‚ö†Ô∏è</span> ' + (data.message || 'Not Active');
                }
                
                // Update events today
                statusEvents.classList.remove('checking');
                if (data.total_events_today > 0) {
                    statusEvents.classList.add('success');
                    statusEvents.querySelector('.status-value').innerHTML = 
                        `<span class="status-icon">üìä</span> ${data.total_events_today} events`;
                } else {
                    statusEvents.classList.add('warning');
                    statusEvents.querySelector('.status-value').innerHTML = 
                        '<span class="status-icon">‚è∏Ô∏è</span> No events today';
                }
                
                // Update last event time
                statusLastEvent.classList.remove('checking');
                if (data.last_event_time) {
                    const lastEventDate = new Date(data.last_event_time);
                    const now = new Date();
                    const diffMs = now - lastEventDate;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    
                    let timeAgo = 'just now';
                    if (diffMins > 60) {
                        timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                    } else if (diffMins > 1) {
                        timeAgo = `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
                    }
                    
                    statusLastEvent.classList.add('success');
                    statusLastEvent.querySelector('.status-value').innerHTML = 
                        `<span class="status-icon">üïê</span> ${timeAgo}`;
                } else {
                    statusLastEvent.classList.add('warning');
                    statusLastEvent.querySelector('.status-value').innerHTML = 
                        '<span class="status-icon">--</span> No events yet';
                }
                
                // Display recent events if available
                if (data.recent_events && data.recent_events.length > 0) {
                    const recentEventsDiv = document.getElementById('recentEvents');
                    const eventsList = document.getElementById('eventsList');
                    
                    recentEventsDiv.style.display = 'block';
                    eventsList.innerHTML = '';
                    
                    data.recent_events.forEach(event => {
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'event-item';
                        
                        const eventTime = new Date(event.timestamp).toLocaleString('da-DK');
                        const eventType = event.type.replace('_', ' ').toUpperCase();
                        
                        eventDiv.innerHTML = `
                            <div class="event-type">${eventType}</div>
                            <div class="event-time">${eventTime}</div>
                            ${event.click_id ? `<div style="color: #6b7280; font-size: 12px;">Click ID: ${event.click_id}</div>` : ''}
                            ${event.page_url ? `<div style="color: #6b7280; font-size: 12px;">Page: ${event.page_url}</div>` : ''}
                        `;
                        
                        eventsList.appendChild(eventDiv);
                    });
                }
                
            } catch (error) {
                console.error('Error checking status:', error);
                
                // Update all status items to error state
                statusConnection.classList.remove('checking');
                statusConnection.classList.add('error');
                statusConnection.querySelector('.status-value').innerHTML = 
                    '<span class="status-icon">‚ùå</span> Connection failed';
                
                statusEvents.classList.remove('checking');
                statusEvents.classList.add('error');
                statusEvents.querySelector('.status-value').innerHTML = '--';
                
                statusLastEvent.classList.remove('checking');
                statusLastEvent.classList.add('error');
                statusLastEvent.querySelector('.status-value').innerHTML = '--';
            } finally {
                checkBtn.disabled = false;
                checkBtn.textContent = 'Check Live Status';
            }
        }
        
        // Simulate tracking events
        async function simulateTracking() {
            const partnerId = document.getElementById('partnerId').value || 'test-partner';
            const resultDiv = document.getElementById('simulateResult');
            
            resultDiv.style.display = 'block';
            
            // Simulate sending tracking events
            const clickId = `dep_test_sim_${Date.now()}`;
            
            try {
                // Send simulated events to the tracking API
                const events = [
                    { type: 'track', data: { click_id: clickId, page_url: '/products', session_id: 'sim_' + Date.now() }},
                    { type: 'track', data: { click_id: clickId, page_url: '/signup', session_id: 'sim_' + Date.now() }},
                    { type: 'conversion', data: { click_id: clickId, conversion_type: 'signup', conversion_value: 0 }}
                ];
                
                for (const event of events) {
                    await fetch('/api/tracking/log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            partner_id: partnerId,
                            partner_domain: window.location.hostname,
                            ...event
                        })
                    });
                }
                
                console.log('Simulated events sent successfully');
                
            } catch (error) {
                console.error('Error simulating events:', error);
            }
        }
        
        // Refresh status
        function refreshStatus() {
            checkTrackingStatus();
        }
        
        // Old simulate test function (keeping for backward compatibility)
        function simulateTest() {
            simulateTracking();
            
            // After simulation, show final step
            setTimeout(() => {
                // Update step 3 to completed
                document.getElementById('step3').classList.remove('current');
                document.getElementById('step3').classList.add('completed');
                
                // Show step 4
                document.getElementById('step4').style.display = 'block';
                document.getElementById('step4').classList.add('completed');
                
                // Scroll to step 4
                setTimeout(() => {
                    document.getElementById('step4').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 500);
            }, 2000);
        }
        
        // Start over
        function startOver() {
            // Clear any existing scripts
            const existingScript = document.querySelector('script[data-dinelportal]');
            if (existingScript) {
                existingScript.remove();
            }
            
            // Reset form
            document.getElementById('partnerId').value = '';
            document.getElementById('addedToWebsite').checked = false;
            
            // Reset steps
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step1').classList.add('current');
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step2').classList.remove('current', 'completed');
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step3').classList.remove('current', 'completed');
            document.getElementById('step4').style.display = 'none';
            document.getElementById('step4').classList.remove('completed');
            
            // Hide results
            document.getElementById('testResult').style.display = 'none';
            document.getElementById('simulateResult').style.display = 'none';
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

    </script>
</body>
</html>